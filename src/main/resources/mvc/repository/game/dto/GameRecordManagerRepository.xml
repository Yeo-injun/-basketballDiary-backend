<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.threeNerds.basketballDiary.mvc.game.repository.dto.GameRecordManagerRepository">

    <select id="findGamesByTeamSeq" resultType="com.threeNerds.basketballDiary.mvc.myTeam.dto.GameRecordDTO">
        /* GameRecordManagerRepository.findGamesByTeamSeq */
        SELECT GAME_SEQ
             , GAME_RECORD_STATE_CODE
             , GAME_TYPE_CODE
             , GAME_YMD
             , GAME_START_TIME
             , GAME_END_TIME
             , GAME_PLACE_ADDRESS
             , GAME_PLACE_NAME
          FROM GAME
         WHERE 1=1
           AND GAME_SEQ IN ( SELECT GAME_SEQ
                               FROM GAME_JOIN_TEAM
                              WHERE TEAM_SEQ = #{teamSeq} )
    </select>

    <select id="findGameJoinTeamRecordsByGameSeq" resultType="com.threeNerds.basketballDiary.mvc.myTeam.dto.GameJoinTeamRecordDTO">
        /* GameRecordManagerRepository.findGameJoinTeamRecordsByGameSeq */
        SELECT gjt.GAME_JOIN_TEAM_SEQ
             , g.GAME_SEQ
             , gjt.TEAM_SEQ
             , gjt.TEAM_NAME
             , gjt.HOME_AWAY_CODE
          FROM GAME g
         INNER JOIN GAME_JOIN_TEAM gjt
            ON g.GAME_SEQ = gjt.GAME_SEQ
         WHERE 1=1
           AND g.GAME_SEQ = #{gameSeq}
    </select>

    <select id="findJoinTeamQuarterRecords" resultType="com.threeNerds.basketballDiary.mvc.myTeam.dto.QuarterRecordDTO">
        /* GameRecordManagerRepository.findJoinTeamQuarterRecords */
        SELECT GAME_SEQ
             , GAME_RECORD_STATE_CODE
             , GAME_TYPE_CODE
             , GAME_YMD
             , GAME_START_TIME
             , GAME_END_TIME
             , GAME_PLACE_ADDRESS
             , GAME_PLACE_NAME
         FROM GAME
        WHERE 1=1
          AND GAME_SEQ IN ( SELECT GAME_SEQ
                              FROM GAME_JOIN_TEAM
                             WHERE TEAM_SEQ = #{teamSeq} )
    </select>


    <select id="findPlayerRecordsByQuarter" resultType="com.threeNerds.basketballDiary.mvc.game.dto.PlayerRecordDTO">
        /** GameRecordManagerRepository.findPlayerRecordsByQuarter */
       SELECT A.GAME_JOIN_TEAM_SEQ
            , A.HOME_AWAY_CODE
            , A.GAME_SEQ
            , A.TEAM_SEQ
            , B.USER_SEQ
            , B.NAME
            , B.BACK_NUMBER
            , B.POSITION_CODE
            , C.QUARTER_PLAYER_RECORDS_SEQ
            , C.QUARTER_CODE
            , C.FREE_THROW
            , C.TRY_FREE_THROW
            , C.TWO_POINT
            , C.TRY_TWO_POINT
            , C.THREE_POINT
            , C.TRY_THREE_POINT
            , C.FREE_THROW + 2 * C.TWO_POINT + 3 * C.TRY_FREE_THROW TOTAL_SCORE
            , C.ASSIST
            , C.REBOUND
            , C.STEAL
            , C.BLOCK
            , C.TURNOVER
            , C.FOUL
            , D.USER_IMAGE_PATH
         FROM GAME_JOIN_TEAM A
        INNER JOIN GAME_JOIN_PLAYER B
           ON A.GAME_JOIN_TEAM_SEQ = B.GAME_JOIN_TEAM_SEQ
        INNER JOIN QUARTER_PLAYER_RECORDS C
           ON B.GAME_JOIN_PLAYER_SEQ = C.GAME_JOIN_PLAYER_SEQ
         LEFT JOIN USER D
           ON B.USER_SEQ = D.USER_SEQ
        <where>
        <choose>
           <when test="quarterPlayerRecordsSeq != null and !''.equals(quarterPlayerRecordsSeq)">
              C.QUARTER_PLAYER_RECORDS_SEQ = #{quarterPlayerRecordsSeq}
           </when>
           <otherwise>
              C.GAME_SEQ = #{gameSeq}
          AND C.GAME_JOIN_PLAYER_SEQ = #{gameJoinPlayerSeq}
          AND C.GAME_JOIN_TEAM_SEQ = #{gameJoinTeamSeq}
          AND C.QUARTER_CODE = #{quarterCode}
            </otherwise>
        </choose>
        </where>
    </select>

    <select id="findAllPlayerRecordsByQuarter" resultType="com.threeNerds.basketballDiary.mvc.game.dto.PlayerRecordDTO">
        /** GameRecordManagerRepository.findAllPlayerRecordsByQuarter */
        SELECT A.GAME_JOIN_TEAM_SEQ
             , A.HOME_AWAY_CODE
             , A.GAME_SEQ
             , A.TEAM_SEQ
             , B.USER_SEQ
             , B.NAME
             , B.BACK_NUMBER
             , B.POSITION_CODE
             , C.QUARTER_PLAYER_RECORDS_SEQ
             , C.QUARTER_CODE
             , C.FREE_THROW
             , C.TRY_FREE_THROW
             , C.TWO_POINT
             , C.TRY_TWO_POINT
             , C.THREE_POINT
             , C.TRY_THREE_POINT
             , C.FREE_THROW + 2 * C.TWO_POINT + 3 * C.TRY_FREE_THROW TOTAL_SCORE
             , C.ASSIST
             , C.REBOUND
             , C.STEAL
             , C.BLOCK
             , C.TURNOVER
             , C.FOUL
             , D.USER_IMAGE_PATH
        FROM GAME_JOIN_TEAM A
       INNER JOIN GAME_JOIN_PLAYER B
          ON A.GAME_JOIN_TEAM_SEQ = B.GAME_JOIN_TEAM_SEQ
       INNER JOIN QUARTER_PLAYER_RECORDS C
          ON B.GAME_JOIN_PLAYER_SEQ = C.GAME_JOIN_PLAYER_SEQ
        LEFT JOIN USER D
          ON B.USER_SEQ = D.USER_SEQ
       WHERE A.GAME_SEQ = #{gameSeq}
         <if test="teamSeq != null and !''.equals(teamSeq)">
         AND A.TEAM_SEQ = #{teamSeq}
         </if>
         <if test="quarterCode != null and !''.equals(quarterCode)">
         AND C.QUARTER_CODE = #{quarterCode}
         </if>
    </select>

    <sql id="homeAwayTeamRecordsByQuarter">
        /**
         * GameRecordManagerRepository.findHomeAwayTeamRecordsByQuarter
         * 홈·어웨이 쿼터별 팀기록 조회이므로, QUARTER_TEAM_RECORDS_SEQ로 식별할 수 없음.
         * 쿼터별 개별팀 기록조회를 원한다면 GameRecordManagerRepository.findTeamRecordsByQuarter 로 조회할것.
         * @author 강창기
         */
        SELECT GAME_SEQ
             , GAME_YMD
             , QUARTER_CODE
             , GAME_START_TIME
             , GAME_END_TIME
             , MAX(QUARTER_TIME)
             , MAX(HOME_TEAM_SEQ) HOME_TEAM_SEQ
             , MAX(AWAY_TEAM_SEQ) AWAY_TEAM_SEQ
             , MAX(HOME_TEAM_NAME) HOME_TEAM_NAME
             , MAX(AWAY_TEAM_NAME) AWAY_TEAM_NAME
             , MAX(HOME_TOTAL_SCORE) HOME_TOTAL_SCORE
             , MAX(AWAY_TOTAL_SCORE) AWAY_TOTAL_SCORE
             , MAX(HOME_FOUL) HOME_FOUL
             , MAX(AWAY_FOUL) AWAY_FOUL
        FROM (
                 SELECT A.GAME_SEQ
                      , A.GAME_YMD
                      , A.GAME_START_TIME
                      , A.GAME_END_TIME
                      , CASE WHEN B.HOME_AWAY_CODE = '01' THEN B.TEAM_SEQ ELSE 0 END HOME_TEAM_SEQ
                      , CASE WHEN B.HOME_AWAY_CODE = '02' THEN B.TEAM_SEQ ELSE 0 END AWAY_TEAM_SEQ
                      , CASE WHEN B.HOME_AWAY_CODE = '01' THEN B.TEAM_NAME ELSE 0 END HOME_TEAM_NAME
                      , CASE WHEN B.HOME_AWAY_CODE = '02' THEN B.TEAM_NAME ELSE 0 END AWAY_TEAM_NAME
                      , CASE WHEN B.HOME_AWAY_CODE = '01'
                                 THEN C.FREE_THROW + 2 * C.TWO_POINT + 3 * C.THREE_POINT ELSE 0
                        END HOME_TOTAL_SCORE
                      , CASE WHEN B.HOME_AWAY_CODE = '02'
                                 THEN C.FREE_THROW + 2 * C.TWO_POINT + 3 * C.THREE_POINT ELSE 0
                        END AWAY_TOTAL_SCORE
                      , CASE WHEN B.HOME_AWAY_CODE = '01' THEN C.FOUL ELSE 0 END HOME_FOUL
                      , CASE WHEN B.HOME_AWAY_CODE = '02' THEN C.FOUL ELSE 0 END AWAY_FOUL
                      , C.QUARTER_CODE
                      , C.QUARTER_TIME
                   FROM GAME A
                  INNER JOIN GAME_JOIN_TEAM B
                     ON A.GAME_SEQ = B.GAME_SEQ
                  INNER JOIN QUARTER_TEAM_RECORDS C
                     ON B.GAME_SEQ = C.GAME_SEQ
                    AND B.GAME_JOIN_TEAM_SEQ = C.GAME_JOIN_TEAM_SEQ
                  WHERE A.GAME_SEQ = #{gameSeq}
             ) A
        GROUP BY GAME_SEQ, GAME_YMD, QUARTER_CODE, GAME_START_TIME, GAME_END_TIME
    </sql>

    <select id="findHomeAwayTeamRecordsByQuarter" resultType="com.threeNerds.basketballDiary.mvc.game.dto.HomeAwayTeamRecordDTO">
       SELECT TMP.*
         FROM (
         <include refid="homeAwayTeamRecordsByQuarter"/>
              ) TMP
        WHERE TMP.QUARTER_CODE = #{quarterCode}
    </select>

    <select id="findAllHomeAwayTeamRecordsByQuarter" resultType="com.threeNerds.basketballDiary.mvc.game.dto.HomeAwayTeamRecordDTO">
        <include refid="homeAwayTeamRecordsByQuarter"/>
    </select>

    <delete id="deleteQuarterPlayerRecords">
        DELETE FROM QUARTER_PLAYER_RECORDS T1 WHERE T1.GAME_SEQ = #{gameSeq} AND T1.QUATER_CODE = #{quarterCode}
    </delete>

    <delete id="deleteQuarterTeamRecords">
        DELETE FROM QUARTER_TEAM_RECORDS T1 WHERE T1.GAME_SEQ = #{gameSeq} AND T1.QUATER_CODE = #{quarterCode}
    </delete>
</mapper>
